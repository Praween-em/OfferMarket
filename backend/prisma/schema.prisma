generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model api_rate_limits {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key          String
  limit_type   String?  @db.VarChar(32)
  window_start DateTime @db.Timestamptz(6)
  window_end   DateTime @db.Timestamptz(6)
  count        Int      @default(0)
  created_at   DateTime @default(now()) @db.Timestamptz(6)

  @@index([key, limit_type], map: "idx_rate_limits_key_type")
}

model audit_logs {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  entity_type  String   @db.VarChar(64)
  entity_id    String?  @db.Uuid
  action       String   @db.VarChar(64)
  performed_by String?  @db.Uuid
  payload      Json?
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  users        users?   @relation(fields: [performed_by], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([entity_type, entity_id], map: "idx_audit_entity")
}

model business_branches {
  id           String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id  String                    @db.Uuid
  branch_name  String?                   @db.VarChar(255)
  address_line String?
  city         String                    @db.VarChar(128)
  area         String?                   @db.VarChar(128)
  state        String?                   @db.VarChar(128)
  pincode      String?                   @db.VarChar(16)
  latitude     Decimal?                  @db.Decimal(9, 6)
  longitude    Decimal?                  @db.Decimal(9, 6)
  location     Unsupported("geography")?
  is_active    Boolean                   @default(true)
  created_at   DateTime                  @default(now()) @db.Timestamptz(6)
  updated_at   DateTime                  @default(now()) @db.Timestamptz(6)
  businesses   businesses                @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  offers       offers[]

  @@index([business_id], map: "idx_branches_businessid")
  @@index([city], map: "idx_branches_city")
}

model business_metrics {
  business_id            String     @id @db.Uuid
  followers              BigInt     @default(0)
  offers_posted          BigInt     @default(0)
  last_metric_updated_at DateTime?  @db.Timestamptz(6)
  businesses             businesses @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model business_reports {
  id                                        String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id                               String?            @db.Uuid
  reported_by                               String?            @db.Uuid
  reason                                    report_reason_enum
  notes                                     String?
  status                                    report_status_enum @default(pending)
  created_at                                DateTime           @default(now()) @db.Timestamptz(6)
  reviewed_by                               String?            @db.Uuid
  reviewed_at                               DateTime?          @db.Timestamptz(6)
  businesses                                businesses?        @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_business_reports_reported_byTousers users?             @relation("business_reports_reported_byTousers", fields: [reported_by], references: [id], onUpdate: NoAction)
  users_business_reports_reviewed_byTousers users?             @relation("business_reports_reviewed_byTousers", fields: [reviewed_by], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([business_id, status], map: "idx_business_reports_businessid_status")
}

model businesses {
  id                       String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  owner_id                 String                     @db.Uuid
  business_name            String                     @db.VarChar(255)
  business_type            business_type_enum         @default(other)
  brand_type               brand_type_enum            @default(local)
  gst_number               String?                    @db.VarChar(32)
  whatsapp_number          String?                    @db.VarChar(20)
  description              String?
  bio                      String?
  logo_url                 String?
  is_verified              Boolean                    @default(false)
  status                   String                     @default("active") @db.VarChar(16)
  created_at               DateTime                   @default(now()) @db.Timestamptz(6)
  updated_at               DateTime                   @default(now()) @db.Timestamptz(6)
  business_branches        business_branches[]
  business_metrics         business_metrics?
  business_reports         business_reports[]
  users                    users                      @relation(fields: [owner_id], references: [id], onUpdate: NoAction)
  campaigns                campaigns[]
  notifications            notifications[]
  user_followed_businesses user_followed_businesses[]

  @@unique([owner_id, business_name], map: "uniq_owner_businessname")
  @@index([owner_id], map: "idx_businesses_owner")
}

model campaigns {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id String     @db.Uuid
  name        String     @db.VarChar(255)
  description String?
  start_date  DateTime?  @db.Timestamptz(6)
  end_date    DateTime?  @db.Timestamptz(6)
  created_by  String?    @db.Uuid
  created_at  DateTime   @default(now()) @db.Timestamptz(6)
  updated_at  DateTime   @default(now()) @db.Timestamptz(6)
  businesses  businesses @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users       users?     @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  offers      offers[]
}

model categories {
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String             @db.VarChar(128)
  parent_id        String?            @db.Uuid
  icon             String?            @db.VarChar(16)
  is_active        Boolean            @default(true)
  created_at       DateTime           @default(now()) @db.Timestamptz(6)
  categories       categories?        @relation("categoriesTocategories", fields: [parent_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_categories categories[]       @relation("categoriesTocategories")
  offer_categories offer_categories[]
}

model media_assets {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  owner_id    String?         @db.Uuid
  url         String
  media_type  media_type_enum @default(image)
  metadata    Json?
  nsfw_score  Float?
  nsfw_status String?         @default("PENDING")
  created_at  DateTime        @default(now()) @db.Timestamptz(6)
  users       users?          @relation(fields: [owner_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  offer_media offer_media[]

  @@index([owner_id], map: "idx_media_owner")
}

model notifications {
  id                String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id           String?                @db.Uuid
  business_id       String?                @db.Uuid
  offer_id          String?                @db.Uuid
  notification_type notification_type_enum @default(generic)
  title             String?                @db.VarChar(255)
  body              String?
  data              Json?
  is_read           Boolean                @default(false)
  created_at        DateTime               @default(now()) @db.Timestamptz(6)
  businesses        businesses?            @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  offers            offers?                @relation(fields: [offer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users             users?                 @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_notifications_user")
}

model offer_categories {
  offer_id    String     @db.Uuid
  category_id String     @db.Uuid
  categories  categories @relation(fields: [category_id], references: [id], onUpdate: NoAction)
  offers      offers     @relation(fields: [offer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([offer_id, category_id])
  @@index([category_id], map: "idx_offer_categories_cat")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model offer_claims {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String?   @db.Uuid
  offer_id    String?   @db.Uuid
  claim_token String?   @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  status      String?   @default("created") @db.VarChar(32)
  metadata    Json?
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  redeemed_at DateTime? @db.Timestamptz(6)
  offers      offers?   @relation(fields: [offer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users       users?    @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  @@index([offer_id], map: "idx_offer_claims_offerid")
  @@index([user_id], map: "idx_offer_claims_userid")
}

model offer_clicks {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String?  @db.Uuid
  offer_id   String?  @db.Uuid
  action     String?  @db.VarChar(128)
  metadata   Json?
  created_at DateTime @default(now()) @db.Timestamptz(6)
  offers     offers?  @relation(fields: [offer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      users?   @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  @@index([offer_id], map: "idx_offer_clicks_offerid")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model offer_items {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  offer_id      String   @db.Uuid
  item_role     String?  @db.VarChar(16)
  item_name     String?  @db.VarChar(255)
  item_category String?  @db.VarChar(128)
  brand         String?  @db.VarChar(128)
  model         String?  @db.VarChar(128)
  min_price     Decimal? @db.Decimal(12, 2)
  max_price     Decimal? @db.Decimal(12, 2)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  offers        offers   @relation(fields: [offer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([offer_id], map: "idx_offer_items_offerid")
}

model offer_media {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  offer_id       String        @db.Uuid
  media_asset_id String?       @db.Uuid
  image_url      String?
  sort_order     Int           @default(0)
  created_at     DateTime      @default(now()) @db.Timestamptz(6)
  media_assets   media_assets? @relation(fields: [media_asset_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  offers         offers        @relation(fields: [offer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([offer_id, sort_order], map: "idx_offer_media_offerid")
}

model offer_metrics {
  offer_id               String    @id @db.Uuid
  views                  BigInt    @default(0)
  clicks                 BigInt    @default(0)
  claims                 BigInt    @default(0)
  saves                  BigInt    @default(0)
  last_metric_updated_at DateTime? @db.Timestamptz(6)
  offers                 offers    @relation(fields: [offer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model offer_reports {
  id                                     String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  offer_id                               String?            @db.Uuid
  reported_by                            String?            @db.Uuid
  reason                                 report_reason_enum
  notes                                  String?
  status                                 report_status_enum @default(pending)
  created_at                             DateTime           @default(now()) @db.Timestamptz(6)
  reviewed_by                            String?            @db.Uuid
  reviewed_at                            DateTime?          @db.Timestamptz(6)
  offers                                 offers?            @relation(fields: [offer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_offer_reports_reported_byTousers users?             @relation("offer_reports_reported_byTousers", fields: [reported_by], references: [id], onUpdate: NoAction)
  users_offer_reports_reviewed_byTousers users?             @relation("offer_reports_reviewed_byTousers", fields: [reviewed_by], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([offer_id, status], map: "idx_offer_reports_offerid_status")
}

model offer_rules {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  offer_id            String          @db.Uuid
  rule_type           offer_type_enum
  discount_value      Decimal?        @db.Decimal(12, 4)
  currency_code       String?         @default("INR") @db.Char(3)
  buy_quantity        Int?
  get_quantity        Int?
  min_purchase_amount Decimal?        @db.Decimal(12, 2)
  max_discount_amount Decimal?        @db.Decimal(12, 2)
  cashback_amount     Decimal?        @db.Decimal(12, 2)
  conditions          Json?
  created_at          DateTime        @default(now()) @db.Timestamptz(6)
  offers              offers          @relation(fields: [offer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([offer_id], map: "idx_offer_rules_offerid")
  @@index([rule_type], map: "idx_offer_rules_ruletype")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model offer_schedules {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  offer_id    String    @db.Uuid
  day_of_week Int?      @db.SmallInt
  start_time  DateTime? @db.Time(6)
  end_time    DateTime? @db.Time(6)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  offers      offers    @relation(fields: [offer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([offer_id], map: "idx_offer_schedules_offerid")
}

model offer_views {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String?  @db.Uuid
  offer_id   String?  @db.Uuid
  session_id String?
  ip_address String?  @db.Inet
  user_agent String?
  created_at DateTime @default(now()) @db.Timestamptz(6)
  offers     offers?  @relation(fields: [offer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      users?   @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  @@index([offer_id], map: "idx_offer_views_offerid")
  @@index([user_id], map: "idx_offer_views_userid")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model offers {
  id                              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  branch_id                       String              @db.Uuid
  campaign_id                     String?             @db.Uuid
  title                           String              @db.VarChar(255)
  short_description               String?             @db.VarChar(500)
  description                     String?
  offer_scope                     String?             @db.VarChar(32)
  start_date                      DateTime            @db.Timestamptz(6)
  end_date                        DateTime            @db.Timestamptz(6)
  status                          offer_status_enum   @default(draft)
  created_by                      String?             @db.Uuid
  approved_by                     String?             @db.Uuid
  created_at                      DateTime            @default(now()) @db.Timestamptz(6)
  updated_at                      DateTime            @default(now()) @db.Timestamptz(6)
  notifications                   notifications[]
  offer_categories                offer_categories[]
  offer_claims                    offer_claims[]
  offer_clicks                    offer_clicks[]
  offer_items                     offer_items[]
  offer_media                     offer_media[]
  offer_metrics                   offer_metrics?
  offer_reports                   offer_reports[]
  offer_rules                     offer_rules[]
  offer_schedules                 offer_schedules[]
  offer_views                     offer_views[]
  users_offers_approved_byTousers users?              @relation("offers_approved_byTousers", fields: [approved_by], references: [id], onUpdate: NoAction)
  business_branches               business_branches   @relation(fields: [branch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  campaigns                       campaigns?          @relation(fields: [campaign_id], references: [id], onUpdate: NoAction)
  users_offers_created_byTousers  users?              @relation("offers_created_byTousers", fields: [created_by], references: [id], onUpdate: NoAction)
  user_saved_offers               user_saved_offers[]

  @@index([branch_id, status, start_date, end_date], map: "idx_offers_branch_status_dates")
  @@index([end_date], map: "idx_offers_end_date")
  @@index([start_date], map: "idx_offers_start_date")
  @@index([status, start_date, end_date], map: "idx_offers_status_dates")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

model user_followed_businesses {
  user_id     String     @db.Uuid
  business_id String     @db.Uuid
  followed_at DateTime   @default(now()) @db.Timestamptz(6)
  businesses  businesses @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users       users      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([user_id, business_id])
  @@index([business_id], map: "idx_followed_businesses_business")
}

model user_saved_offers {
  user_id  String   @db.Uuid
  offer_id String   @db.Uuid
  saved_at DateTime @default(now()) @db.Timestamptz(6)
  offers   offers   @relation(fields: [offer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users    users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([user_id, offer_id])
}

model users {
  id                                                   String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  phone                                                String                     @unique @db.VarChar(20)
  email                                                String?                    @db.VarChar(320)
  role                                                 role_enum                  @default(consumer)
  is_phone_verified                                    Boolean                    @default(false)
  status                                               user_status_enum           @default(active)
  display_name                                         String?                    @db.VarChar(255)
  profile_picture                                      String?
  metadata                                             Json?
  created_at                                           DateTime                   @default(now()) @db.Timestamptz(6)
  updated_at                                           DateTime                   @default(now()) @db.Timestamptz(6)
  audit_logs                                           audit_logs[]
  business_reports_business_reports_reported_byTousers business_reports[]         @relation("business_reports_reported_byTousers")
  business_reports_business_reports_reviewed_byTousers business_reports[]         @relation("business_reports_reviewed_byTousers")
  businesses                                           businesses[]
  campaigns                                            campaigns[]
  media_assets                                         media_assets[]
  notifications                                        notifications[]
  offer_claims                                         offer_claims[]
  offer_clicks                                         offer_clicks[]
  offer_reports_offer_reports_reported_byTousers       offer_reports[]            @relation("offer_reports_reported_byTousers")
  offer_reports_offer_reports_reviewed_byTousers       offer_reports[]            @relation("offer_reports_reviewed_byTousers")
  offer_views                                          offer_views[]
  offers_offers_approved_byTousers                     offers[]                   @relation("offers_approved_byTousers")
  offers_offers_created_byTousers                      offers[]                   @relation("offers_created_byTousers")
  user_followed_businesses                             user_followed_businesses[]
  user_saved_offers                                    user_saved_offers[]

  @@index([role, status], map: "idx_users_role_status")
}

enum brand_type_enum {
  local
  chain
  franchise
}

enum business_type_enum {
  electronics
  clothing
  grocery
  footwear
  restaurant
  other
}

enum media_type_enum {
  image
  video
  other
}

enum notification_type_enum {
  new_offer
  offer_expiring
  offer_approved
  offer_rejected
  generic
}

enum offer_status_enum {
  draft
  pending
  active
  paused
  expired
  rejected
}

enum offer_type_enum {
  flat
  percentage
  buy_x_get_y
  bogo
  cashback
  tiered_volume
  tiered_spending
  bundle_fixed_price
  free_gift
  loyalty_points
  mystery_reward
  referral
  first_order
  custom
}

enum report_reason_enum {
  fake
  misleading
  expired
  inaccurate
  spam
  other
}

enum report_status_enum {
  pending
  reviewed
  action_taken
}

enum role_enum {
  consumer
  business_owner
  admin
}

enum user_status_enum {
  active
  suspended
  banned
}
